#!/bin/bash

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}üöÄ –ù–∞—á–∏–Ω–∞—é –¥–µ–ø–ª–æ–π...${NC}\n"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–±–æ—Ä–∫—É –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º
echo -e "${BLUE}üî® –ü—Ä–æ–≤–µ—Ä—è—é —Å–±–æ—Ä–∫—É –ø—Ä–æ–µ–∫—Ç–∞...${NC}"
npm run build

if [ $? -ne 0 ]; then
  echo -e "\n${RED}‚ùå –û–®–ò–ë–ö–ê: –°–±–æ—Ä–∫–∞ –Ω–µ –ø—Ä–æ—à–ª–∞!${NC}"
  echo -e "${RED}   –ò—Å–ø—Ä–∞–≤—å—Ç–µ –æ—à–∏–±–∫–∏ –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º${NC}"
  echo -e "${YELLOW}   –ó–∞–ø—É—Å—Ç–∏—Ç–µ 'npm run build' –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏${NC}"
  exit 1
fi

echo -e "${GREEN}‚úÖ –°–±–æ—Ä–∫–∞ –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ${NC}\n"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å git
echo -e "${BLUE}üìã –ü—Ä–æ–≤–µ—Ä—è—é —Å—Ç–∞—Ç—É—Å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è...${NC}"
git status --short

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è
if git diff-index --quiet HEAD --; then
  echo -e "${YELLOW}‚ö†Ô∏è  –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –∫–æ–º–º–∏—Ç–∞${NC}"
  
  # –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ —á—Ç–æ –ø—É—à–∏—Ç—å
  LOCAL=$(git rev-parse @)
  REMOTE=$(git rev-parse @{u} 2>/dev/null || echo "")
  
  if [ -z "$REMOTE" ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  –£–¥–∞–ª–µ–Ω–Ω—ã–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω${NC}"
    exit 0
  fi
  
  if [ "$LOCAL" = "$REMOTE" ]; then
    echo -e "${GREEN}‚úÖ –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —É–∂–µ –∑–∞–ø—É—à–µ–Ω—ã${NC}"
    echo -e "${BLUE}üì¶ Netlify –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–¥–µ–ø–ª–æ–∏—Ç –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –∫–æ–º–º–∏—Ç–µ${NC}"
    exit 0
  else
    echo -e "${BLUE}üì§ –ï—Å—Ç—å –∫–æ–º–º–∏—Ç—ã –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏, –ø—É—à–∏–º...${NC}"
    git push
    if [ $? -eq 0 ]; then
      echo -e "${GREEN}‚úÖ –£—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—à–µ–Ω–æ –≤ GitHub${NC}"
      echo -e "${BLUE}üì¶ Netlify –Ω–∞—á–Ω–µ—Ç –¥–µ–ø–ª–æ–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏...${NC}"
    else
      echo -e "${RED}‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ push –≤ GitHub${NC}"
      exit 1
    fi
    exit 0
  fi
fi

# –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
echo -e "\n${BLUE}‚ûï –î–æ–±–∞–≤–ª—è—é –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ staging...${NC}"
git add .

if [ $? -ne 0 ]; then
  echo -e "${RED}‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Ñ–∞–π–ª–æ–≤${NC}"
  exit 1
fi

# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —á—Ç–æ –±—É–¥–µ—Ç –∑–∞–∫–æ–º–º–∏—á–µ–Ω–æ
echo -e "${BLUE}üìù –ò–∑–º–µ–Ω–µ–Ω–∏—è –¥–ª—è –∫–æ–º–º–∏—Ç–∞:${NC}"
git status --short

# –°–æ–∑–¥–∞–µ–º –∫–æ–º–º–∏—Ç
COMMIT_MSG="Update: $(date +'%Y-%m-%d %H:%M')"
echo -e "\n${BLUE}üíæ –°–æ–∑–¥–∞—é –∫–æ–º–º–∏—Ç: ${COMMIT_MSG}${NC}"
git commit -m "$COMMIT_MSG"

if [ $? -ne 0 ]; then
  echo -e "${RED}‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–æ–º–º–∏—Ç–∞${NC}"
  exit 1
fi

COMMIT_HASH=$(git rev-parse --short HEAD)
echo -e "${GREEN}‚úÖ –ö–æ–º–º–∏—Ç —Å–æ–∑–¥–∞–Ω: ${COMMIT_HASH}${NC}"

# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∫–æ–º–º–∏—Ç–∞
echo -e "\n${BLUE}üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–æ–º–º–∏—Ç–∞:${NC}"
git show --stat --oneline HEAD

# –ü—É—à–∏–º –≤ GitHub
echo -e "\n${BLUE}üì§ –û—Ç–ø—Ä–∞–≤–ª—è—é –≤ GitHub...${NC}"
git push

if [ $? -eq 0 ]; then
  echo -e "\n${GREEN}‚úÖ –£—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—à–µ–Ω–æ –≤ GitHub${NC}"
  echo -e "${GREEN}üì¶ Netlify –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞—á–Ω–µ—Ç –¥–µ–ø–ª–æ–π...${NC}"
  echo -e "\n${BLUE}üîó –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å –¥–µ–ø–ª–æ—è –Ω–∞ Netlify${NC}"
  echo -e "${BLUE}   –û–±—ã—á–Ω–æ –¥–µ–ø–ª–æ–π –∑–∞–Ω–∏–º–∞–µ—Ç 1-2 –º–∏–Ω—É—Ç—ã${NC}"
  
  # –ü—ã—Ç–∞–µ–º—Å—è –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å URL –ø—Ä–æ–µ–∫—Ç–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å remote)
  REMOTE_URL=$(git remote get-url origin 2>/dev/null || echo "")
  if [[ $REMOTE_URL == *"github.com"* ]]; then
    REPO=$(echo $REMOTE_URL | sed -E 's/.*github.com[:/]([^/]+\/[^/]+)(\.git)?$/\1/')
    echo -e "\n${BLUE}üìã –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: https://github.com/${REPO}${NC}"
    echo -e "${BLUE}üì¶ Netlify –¥–µ–ø–ª–æ–π: https://app.netlify.com/sites/${REPO##*/}/deploys${NC}"
  fi
  
  echo -e "\n${YELLOW}üí° –°–æ–≤–µ—Ç: –û—Ç–∫—Ä–æ–π—Ç–µ Netlify Dashboard —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Å—Ç–∞—Ç—É—Å –¥–µ–ø–ª–æ—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏${NC}"
else
  echo -e "\n${RED}‚ùå –û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ GitHub${NC}"
  echo -e "${RED}   –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:${NC}"
  echo -e "${RED}   - –ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É${NC}"
  echo -e "${RED}   - –ù–µ—Ç –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—é${NC}"
  echo -e "${RED}   - –ö–æ–Ω—Ñ–ª–∏–∫—Ç —Å —É–¥–∞–ª–µ–Ω–Ω–æ–π –≤–µ—Ç–∫–æ–π${NC}"
  echo -e "${YELLOW}   –ü–æ–ø—Ä–æ–±—É–π—Ç–µ: git pull --rebase, –∑–∞—Ç–µ–º npm run deploy${NC}"
  exit 1
fi

echo -e "\n${GREEN}‚ú® –î–µ–ø–ª–æ–π –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞–Ω —É—Å–ø–µ—à–Ω–æ!${NC}"

