<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <meta name="theme-color" content="#ffffff" />
  <title>Clarity</title>
  <script>
    // #region agent log
    (function() {
      const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
      const logEndpoint = 'http://127.0.0.1:7250/ingest/ee1f61b1-2553-4bd0-a919-0157b6f4b1e5';
      const log = (msg, data, hypothesisId) => {
        const logData = {location:'index.html',message:msg,data:data||{},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:hypothesisId||'A'};
        console.log('[DEBUG]', msg, data || '');
        if (isLocalhost) {
          fetch(logEndpoint, {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(logData)}).catch(()=>{});
        }
      };
      log('HTML loaded', {url: window.location.href, userAgent: navigator.userAgent}, 'A');
      
      // Отслеживаем загрузку Telegram скрипта
      const telegramLoadStart = Date.now();
      window.addEventListener('error', (e) => {
        log('Global error', {message: e.message, filename: e.filename, lineno: e.lineno, colno: e.colno, error: e.error?.toString()}, 'B');
      }, true);
      
      // Детальное отслеживание загрузки ресурсов
      const resourceObserver = new PerformanceObserver((list) => {
        list.getEntries().forEach(entry => {
          if (entry.initiatorType === 'script' || entry.initiatorType === 'link' || entry.initiatorType === 'other') {
            const name = entry.name.split('/').pop();
            const isFailed = entry.transferSize === 0 && entry.duration === 0;
            const details = {
              name: name,
              fullUrl: entry.name,
              type: entry.initiatorType,
              duration: Math.round(entry.duration),
              size: entry.transferSize,
              decodedSize: entry.decodedBodySize,
              encodedSize: entry.encodedBodySize,
              status: entry.responseStatus,
              failed: isFailed,
              startTime: Math.round(entry.startTime),
              domain: new URL(entry.name).hostname
            };
            
            if (isFailed || entry.responseStatus >= 400) {
              log('Resource FAILED', details, 'A');
            } else {
              log('Resource loaded', details, 'A');
            }
          }
        });
      });
      try {
        resourceObserver.observe({entryTypes: ['resource', 'navigation']});
      } catch(e) {
        log('PerformanceObserver error', {error: e.toString()}, 'A');
      }
      
      // Отслеживаем изменения состояния сети
      if (navigator.onLine !== undefined) {
        window.addEventListener('online', () => log('Network: online', {}, 'F'));
        window.addEventListener('offline', () => log('Network: offline', {}, 'F'));
        log('Network status', {online: navigator.onLine, connection: navigator.connection?.effectiveType}, 'F');
      }
      
      // Детальное отслеживание ошибок загрузки модулей
      window.addEventListener('error', (e) => {
        const errorDetails = {
          message: e.message,
          filename: e.filename,
          lineno: e.lineno,
          colno: e.colno,
          error: e.error?.toString(),
          stack: e.error?.stack,
          target: e.target ? {
            tagName: e.target.tagName,
            src: e.target.src,
            type: e.target.type,
            id: e.target.id,
            className: e.target.className
          } : null
        };
        
        if (e.target && e.target.tagName === 'SCRIPT') {
          log('Script load ERROR', errorDetails, 'B');
        } else {
          log('Global ERROR', errorDetails, 'B');
        }
      }, true);
      
      // Отслеживаем unhandled promise rejections
      window.addEventListener('unhandledrejection', (e) => {
        log('Unhandled promise rejection', {
          reason: e.reason?.toString(),
          promise: e.promise
        }, 'B');
      });
      
      // Проверяем, какие скрипты есть в DOM
      setTimeout(() => {
        const scripts = Array.from(document.querySelectorAll('script'));
        log('Scripts in DOM', {
          count: scripts.length,
          scripts: scripts.map(s => ({src: s.src, type: s.type, async: s.async, defer: s.defer}))
        }, 'B');
      }, 200);
      
      // Проверяем загрузку Telegram через небольшой таймаут
      setTimeout(() => {
        log('Telegram check', {hasTelegram: !!window.Telegram, hasWebApp: !!window.Telegram?.WebApp, loadTime: Date.now() - telegramLoadStart}, 'D');
      }, 100);
    })();
    // #endregion
  </script>
  <script src="https://telegram.org/js/telegram-web-app.js" defer onerror="console.warn('Failed to load Telegram WebApp script'); window.Telegram = window.Telegram || {};"></script>
</head>
<body>
  <div id="root"></div>
  <script type="module" src="/src/main.tsx"></script>
</body>
</html>

